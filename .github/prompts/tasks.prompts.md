# KubeZ 开发任务清单

**版本**: v1.0-MVP  
**创建日期**: 2025年12月1日  
**开发模式**: TDD (测试驱动开发)

---

## 任务说明

本文档包含 KubeZ 项目 MVP 版本的所有开发任务。所有任务必须严格遵循 TDD 开发流程：

1. **Red**: 先编写失败的测试用例
2. **Green**: 编写最小代码使测试通过
3. **Refactor**: 重构代码提升质量

每个任务的验收标准即为测试用例的通过条件。

---

## 第一阶段：基础设施和数据模型

### Task 1.1: 数据库初始化和迁移

**功能描述**: 创建数据库结构，使用 PostgreSQL 作为数据库

**验收标准**:

- [ ] 能够执行数据库迁移命令 `kubez migrate up`
- [ ] 能够回滚数据库迁移 `kubez migrate down`

- [ ] 能够查看迁移状态 `kubez migrate status`
- [ ] 支持 PostgreSQL 数据库连接

- [ ] 迁移失败时能够正确回滚

**测试要点**:

- 测试迁移命令在空数据库上执行成功
- 测试重复执行迁移命令不报错
- 测试回滚后数据库恢复到之前状态
- 测试 PostgreSQL 特定功能的兼容性

---

### Task 1.2: 用户表数据模型

**功能描述**: 创建用户表，存储用户基本信息和认证数据

**验收标准**:

- [ ] 用户表包含必需字段：id, username, password_hash, email, is_super_admin, created_at, updated_at
- [ ] username 字段有唯一索引

- [ ] 能够成功创建用户记录
- [ ] 密码以哈希形式存储（不存储明文）

- [ ] 创建时间和更新时间自动生成

**测试要点**:

- 测试创建用户成功
- 测试 username 唯一性约束
- 测试密码哈希存储
- 测试时间戳自动填充
- 测试字段验证（如 email 格式、username 长度）

---

### Task 1.3: 集群表数据模型

**功能描述**: 创建集群表，存储 Kubernetes 集群连接信息

**验收标准**:

- [ ] 集群表包含必需字段：id, name, display_name, karmada_cluster_name,
  labels, kubeconfig, api_server, version, status, last_health_check,
  health_info, created_by, created_at, updated_at
- [ ] name 字段有唯一索引

- [ ] status 和 karmada_cluster_name 字段有索引
- [ ] 能够成功创建集群记录

- [ ] labels 以 JSON 格式存储
- [ ] kubeconfig 字段加密存储

**测试要点**:

- 测试创建集群记录
- 测试 name 唯一性约束
- 测试 labels JSON 序列化和反序列化
- 测试 kubeconfig 加密和解密
- 测试状态字段枚举值验证
- 测试外键关联（created_by 关联用户）

---

### Task 1.5: 配置管理系统

**功能描述**: 实现配置文件加载和环境变量管理（使用 Viper）

**验收标准**:

- [ ] 能够从 YAML 配置文件加载配置
- [ ] 能够从环境变量加载配置（前缀 KUBEZ_）

- [ ] 配置优先级：CLI 参数 > 环境变量 > 配置文件 > 默认值
- [ ] 能够执行 `kubez config validate` 验证配置

- [ ] 能够执行 `kubez config show` 显示当前配置
- [ ] 能够执行 `kubez config init` 生成默认配置文件

**测试要点**:

- 测试加载 YAML 配置文件
- 测试环境变量覆盖配置文件
- 测试 CLI 参数覆盖环境变量
- 测试配置验证（必填项检查、格式验证）
- 测试默认配置文件生成
- 测试配置文件不存在时的默认值

---

### Task 1.6: CLI 命令框架

**功能描述**: 实现 Cobra 命令行框架，提供基础命令结构

**验收标准**:

- [ ] 能够执行 `kubez` 显示帮助信息
- [ ] 能够执行 `kubez version` 显示版本信息

- [ ] 能够执行 `kubez --help` 显示完整命令树
- [ ] 所有子命令都有清晰的描述和示例

- [ ] 支持 `--config` 全局参数指定配置文件路径
- [ ] 支持 `--debug` 全局参数开启调试日志

**测试要点**:

- 测试根命令帮助输出
- 测试版本命令输出格式
- 测试全局参数解析
- 测试无效命令时的错误提示
- 测试命令补全功能

---

### Task 1.7: 用户管理 CLI 命令

**功能描述**: 提供用户管理的命令行工具

**验收标准**:

- [ ] 能够执行 `kubez user create` 创建用户
- [ ] 能够执行 `kubez user list` 列出所有用户

- [ ] 能够执行 `kubez user delete` 删除用户
- [ ] 能够执行 `kubez user reset-password` 重置密码

- [ ] 创建首个用户时自动设为 super_admin
- [ ] 支持交互式输入密码（隐藏显示）

- [ ] 支持通过参数指定用户信息

**测试要点**:

- 测试创建用户成功
- 测试首个用户为 super_admin
- 测试列出用户
- 测试删除用户
- 测试重置密码
- 测试交互式输入
- 测试参数验证
- 测试用户名冲突处理

---

### Task 1.8: 数据加密密钥管理

**功能描述**: 管理 kubeconfig 加密所需的密钥

**验收标准**:

- [ ] 能够生成加密密钥（AES-256-GCM）
- [ ] 能够从环境变量读取密钥

- [ ] 能够从配置文件读取密钥
- [ ] 密钥未配置时拒绝启动

- [ ] 支持密钥轮换（多版本密钥）
- [ ] 能够使用旧密钥解密，新密钥加密

- [ ] 提供密钥生成命令 `kubez config generate-key`

**测试要点**:

- 测试密钥生成
- 测试从环境变量读取
- 测试从配置文件读取
- 测试密钥未配置拒绝启动
- 测试密钥轮换
- 测试多版本密钥解密
- 测试密钥格式验证

---

## 第二阶段：集群管理核心功能

### Task 2.1: 集群注册功能

**功能描述**: 通过 kubeconfig 文件注册新的 Kubernetes 集群

**验收标准**:

- [ ] 能够接收 kubeconfig 内容并解析
- [ ] 能够验证 kubeconfig 格式正确性

- [ ] 能够测试集群连接性（连接 API Server）
- [ ] 能够提取集群基本信息（API Server 地址、版本）

- [ ] 能够加密存储 kubeconfig
- [ ] 能够将集群信息保存到数据库

- [ ] 集群名称重复时返回错误
- [ ] 连接失败时返回清晰的错误信息

**测试要点**:

- 测试有效 kubeconfig 注册成功
- 测试无效 kubeconfig 格式被拒绝
- 测试无法连接的集群返回错误
- 测试集群名称重复验证
- 测试 kubeconfig 加密存储
- 测试提取集群版本信息
- 测试数据库事务完整性（失败时回滚）

---

### Task 2.2: 集群列表查询

**功能描述**: 查询所有已注册的集群列表，支持筛选和搜索

**验收标准**:

- [ ] 能够获取所有集群列表
- [ ] 能够按状态筛选（online/offline/error）

- [ ] 能够按关键词搜索（名称、标签）
- [ ] 能够分页查询（指定页码和每页数量）

- [ ] 返回集群基本信息（名称、状态、节点数、Pod数、版本）
- [ ] 能够按创建时间排序

- [ ] 空结果时返回空列表

**测试要点**:

- 测试查询所有集群
- 测试按状态筛选
- 测试关键词搜索
- 测试分页功能（首页、中间页、尾页）
- 测试排序功能
- 测试空数据库返回空列表
- 测试查询性能（100+ 集群）

---

### Task 2.3: 集群详情查询

**功能描述**: 获取单个集群的详细信息

**验收标准**:

- [ ] 能够根据集群 ID 查询详情
- [ ] 返回集群完整信息（除 kubeconfig）

- [ ] 返回健康检查信息（状态、延迟、证书有效期）
- [ ] 返回资源统计（节点数、Pod 数、命名空间数）

- [ ] 集群不存在时返回 404 错误
- [ ] 能够根据集群名称查询详情

**测试要点**:

- 测试根据 ID 查询成功
- 测试根据名称查询成功
- 测试集群不存在返回错误
- 测试返回数据完整性
- 测试 kubeconfig 未被返回（安全性）
- 测试健康信息包含在响应中

---

### Task 2.4: 集群信息更新

**功能描述**: 更新集群的可修改信息（名称、标签等）

**验收标准**:

- [ ] 能够更新集群显示名称
- [ ] 能够更新集群标签

- [ ] 能够更新 kubeconfig（重新加密存储）
- [ ] 不允许更新集群 ID

- [ ] 更新时自动更新 updated_at 时间戳
- [ ] 名称重复时返回错误

- [ ] 集群不存在时返回 404 错误
- [ ] 部分更新成功（仅更新提供的字段）

**测试要点**:

- 测试更新显示名称
- 测试更新标签
- 测试更新 kubeconfig
- 测试部分字段更新
- 测试名称重复验证
- 测试集群不存在处理
- 测试时间戳自动更新
- 测试并发更新的数据一致性

---

### Task 2.5: 集群删除功能

**功能描述**: 从系统中删除已注册的集群

**验收标准**:

- [ ] 能够根据集群 ID 删除集群
- [ ] 删除时同时清理加密的 kubeconfig

- [ ] 删除时同时清理相关权限记录（OpenFGA）
- [ ] 集群不存在时返回 404 错误

- [ ] 删除操作记录审计日志
- [ ] 支持软删除（标记为已删除而非物理删除）

**测试要点**:

- 测试删除存在的集群
- 测试集群不存在处理
- 测试 kubeconfig 被清理
- 测试权限记录被清理
- 测试审计日志记录
- 测试软删除和硬删除
- 测试删除操作的事务性

---

### Task 2.6: 集群健康检查服务

**功能描述**: 定期检测集群连接状态和健康度

**验收标准**:

- [ ] 能够检测集群 API Server 连通性
- [ ] 能够测量 API 响应时间

- [ ] 能够检查集群证书有效期
- [ ] 能够统计节点状态（Ready/NotReady）

- [ ] 能够统计 Pod 状态（Running/Pending/Failed）
- [ ] 检查结果更新到数据库（status, health_info, last_health_check）

- [ ] 连接失败时更新状态为 offline
- [ ] 连接成功时更新状态为 online

- [ ] 证书即将过期时记录警告信息

**测试要点**:

- 测试健康集群检查成功
- 测试离线集群检查失败
- 测试响应时间测量
- 测试证书有效期检查
- 测试节点状态统计
- 测试 Pod 状态统计
- 测试数据库状态更新
- 测试检查超时处理

---

### Task 2.7: 定期健康检查调度

**功能描述**: 每 30 秒自动检查所有集群健康状态

**验收标准**:

- [ ] 能够启动后台定期任务（30 秒周期）
- [ ] 能够遍历所有集群执行健康检查

- [ ] 能够并发检查多个集群（避免阻塞）
- [ ] 能够优雅关闭调度器（收到信号时停止）

- [ ] 检查失败不影响其他集群检查
- [ ] 能够手动触发单个集群的健康检查

**测试要点**:

- 测试调度器启动和周期执行
- 测试并发检查多个集群
- 测试单个集群失败不影响其他集群
- 测试优雅关闭（context 取消）
- 测试手动触发健康检查
- 测试调度器重启后恢复

---

### Task 2.8: 集群切换功能

**功能描述**: 支持用户在不同集群之间切换（前端状态管理）

**验收标准**:

- [ ] 能够记录用户当前选中的集群
- [ ] 能够获取用户上次选中的集群

- [ ] 能够更新用户选中的集群
- [ ] 切换到不存在的集群时返回错误

- [ ] 用户无权访问的集群无法切换
- [ ] 记录用户最近访问的集群列表（最多 5 个）

**测试要点**:

- 测试记录当前选中集群
- 测试获取上次选中集群
- 测试切换到有效集群
- 测试切换到无效集群
- 测试权限验证
- 测试最近访问列表更新
- 测试跨会话保持选中状态

---

### Task 2.9: 集群对比视图数据

**功能描述**: 提供多个集群的关键指标用于对比展示

**验收标准**:

- [ ] 能够获取所有集群的关键指标（一次查询）
- [ ] 返回每个集群的状态、节点数、Pod 数、CPU/内存使用率

- [ ] 能够按指标排序（CPU 使用率、内存使用率）
- [ ] 能够筛选异常集群（状态非 online）

- [ ] 数据包含最后更新时间
- [ ] 响应时间 < 3 秒（10 个集群）

**测试要点**:

- 测试批量获取集群指标
- 测试按 CPU 使用率排序
- 测试按内存使用率排序
- 测试筛选异常集群
- 测试数据完整性
- 测试查询性能（10+ 集群）
- 测试缓存机制（避免频繁查询 K8s API）

---

## 第三阶段：Kubernetes 资源查询

### Task 3.1: 命名空间列表查询

**功能描述**: 查询指定集群的所有命名空间

**验收标准**:

- [ ] 能够获取指定集群的所有命名空间
- [ ] 返回命名空间基本信息（名称、状态、创建时间）

- [ ] 返回每个命名空间的资源统计（Pod 数、Deployment 数、Service 数）
- [ ] 能够按名称搜索命名空间

- [ ] 集群不存在时返回 404 错误
- [ ] 集群离线时返回连接错误

- [ ] 按名称字母顺序排序

**测试要点**:

- 测试查询存在的集群命名空间
- 测试集群不存在处理
- 测试集群离线处理
- 测试名称搜索
- 测试资源统计准确性
- 测试系统命名空间包含在结果中
- 测试空集群返回默认命名空间

---

### Task 3.2: 节点列表查询

**功能描述**: 查询指定集群的所有节点

**验收标准**:

- [ ] 能够获取指定集群的所有节点
- [ ] 返回节点基本信息（名称、状态、角色、IP 地址）

- [ ] 返回节点资源信息（CPU 容量/使用率、内存容量/使用率）
- [ ] 返回节点上的 Pod 数量

- [ ] 能够按状态筛选（Ready/NotReady）
- [ ] 能够按名称搜索

- [ ] 能够按 CPU/内存使用率排序
- [ ] 集群不存在或离线时返回错误

**测试要点**:

- 测试查询所有节点
- 测试按状态筛选
- 测试按名称搜索
- 测试按资源使用率排序
- 测试资源统计准确性
- 测试 Master 和 Worker 节点角色识别
- 测试节点状态判断（Ready 条件）

---

### Task 3.3: 节点详情查询

**功能描述**: 获取单个节点的详细信息

**验收标准**:

- [ ] 能够根据节点名称查询详情
- [ ] 返回节点完整信息（标签、注解、条件）

- [ ] 返回节点资源分配情况（requests/limits）
- [ ] 返回节点上运行的所有 Pod 列表

- [ ] 返回节点容量信息（CPU、内存、存储、Pod 数上限）
- [ ] 返回节点系统信息（操作系统、内核版本、容器运行时）

- [ ] 节点不存在时返回 404 错误

**测试要点**:

- 测试查询存在的节点
- 测试节点不存在处理
- 测试资源分配统计
- 测试 Pod 列表完整性
- 测试容量信息准确性
- 测试系统信息解析
- 测试标签和注解返回

---

### Task 3.4: Pod 列表查询

**功能描述**: 查询指定命名空间的所有 Pod

**验收标准**:

- [ ] 能够获取指定命名空间的所有 Pod
- [ ] 返回 Pod 基本信息（名称、状态、重启次数、所在节点）

- [ ] 返回 Pod 资源使用情况（CPU、内存）
- [ ] 能够按状态筛选（Running/Pending/Failed 等）

- [ ] 能够按名称搜索
- [ ] 能够按节点筛选

- [ ] 能够分页查询
- [ ] 命名空间不存在时返回 404 错误

**测试要点**:

- 测试查询所有 Pod
- 测试按状态筛选
- 测试按名称搜索
- 测试按节点筛选
- 测试分页功能
- 测试资源使用统计
- 测试多容器 Pod 处理
- 测试 Pod 状态准确判断

---

### Task 3.5: Pod 详情查询

**功能描述**: 获取单个 Pod 的详细信息

**验收标准**:

- [ ] 能够根据 Pod 名称查询详情
- [ ] 返回 Pod 完整信息（标签、注解、容器列表）

- [ ] 返回所有容器的状态和重启次数
- [ ] 返回 Pod 的 IP 地址和 QoS 等级

- [ ] 返回 Pod 的资源 requests 和 limits
- [ ] 返回 Pod 的环境变量和挂载卷

- [ ] 返回 Pod 的 Owner 信息（所属 Deployment/StatefulSet 等）
- [ ] Pod 不存在时返回 404 错误

**测试要点**:

- 测试查询存在的 Pod
- 测试 Pod 不存在处理
- 测试多容器 Pod 信息完整性
- 测试 Owner 引用解析
- 测试资源配置返回
- 测试环境变量和卷信息
- 测试 InitContainer 信息

---

### Task 3.6: Pod 删除功能（重启）

**功能描述**: 删除 Pod 实现重启功能

**验收标准**:

- [ ] 能够根据 Pod 名称删除 Pod
- [ ] 删除操作记录审计日志

- [ ] Pod 不存在时返回 404 错误
- [ ] 删除失败时返回清晰错误信息

- [ ] 验证用户有删除权限
- [ ] 支持优雅删除（GracePeriod）

- [ ] 支持强制删除选项

**测试要点**:

- 测试删除存在的 Pod
- 测试 Pod 不存在处理
- 测试权限验证
- 测试审计日志记录
- 测试优雅删除
- 测试强制删除
- 测试删除后 Pod 由控制器重建

---

### Task 3.7: Pod 事件查询

**功能描述**: 获取 Pod 相关的 Kubernetes 事件

**验收标准**:

- [ ] 能够获取指定 Pod 的所有事件
- [ ] 返回事件信息（类型、原因、消息、时间）

- [ ] 事件按时间倒序排列（最新的在前）
- [ ] 能够筛选事件类型（Normal/Warning/Error）

- [ ] 能够指定事件数量限制（默认 100 条）
- [ ] Pod 不存在时返回 404 错误

- [ ] 无事件时返回空列表

**测试要点**:

- 测试查询 Pod 事件
- 测试事件排序
- 测试按类型筛选
- 测试事件数量限制
- 测试 Pod 不存在处理
- 测试无事件场景
- 测试事件时间格式化

---

### Task 3.8: 跨集群资源查询

**功能描述**: 通过 Karmada 统一查询所有集群的资源

**验收标准**:

- [ ] 能够一次查询所有集群的 Pod
- [ ] 返回结果包含集群来源信息

- [ ] 能够按集群筛选结果
- [ ] 能够聚合统计资源数量

- [ ] 支持分页查询
- [ ] Karmada 不可用时降级到逐个集群查询

- [ ] 响应时间 < 5 秒（10 个集群）

**测试要点**:

- 测试跨集群查询 Pod
- 测试集群来源标识
- 测试按集群筛选
- 测试聚合统计
- 测试分页功能
- 测试 Karmada 不可用时的降级策略
- 测试查询性能

---

### Task 3.9: ConfigMap 和 Secret 查询

**功能描述**: 查询命名空间中的 ConfigMap 和 Secret 资源

**验收标准**:

- [ ] 能够获取 ConfigMap 列表
- [ ] 能够获取 ConfigMap 详情（包含数据内容）

- [ ] 能够获取 Secret 列表
- [ ] 能够获取 Secret 详情（敏感数据 Base64 解码）

- [ ] Secret 查询需要额外权限验证
- [ ] 能够按名称搜索

- [ ] 能够查看引用该资源的 Pod 列表

**测试要点**:

- 测试 ConfigMap 列表查询
- 测试 ConfigMap 详情查询
- 测试 Secret 列表查询
- 测试 Secret 详情查询
- 测试 Secret 权限验证
- 测试数据解码
- 测试引用关系查询
- 测试大数据 ConfigMap/Secret

---

### Task 3.10: StatefulSet 和 DaemonSet 查询

**功能描述**: 查询 StatefulSet 和 DaemonSet 工作负载

**验收标准**:

- [ ] 能够获取 StatefulSet 列表
- [ ] 能够获取 StatefulSet 详情（包含 Pod 管理策略）

- [ ] 能够获取 DaemonSet 列表
- [ ] 能够获取 DaemonSet 详情（包含节点选择器）

- [ ] 能够查看关联的 Pod 列表
- [ ] 能够查看 PVC 关联（StatefulSet）

- [ ] 能够查看节点调度情况（DaemonSet）

**测试要点**:

- 测试 StatefulSet 列表查询
- 测试 StatefulSet 详情查询
- 测试 DaemonSet 列表查询
- 测试 DaemonSet 详情查询
- 测试 Pod 关联
- 测试 PVC 关联查询
- 测试节点调度查询
- 测试滚动更新状态

---

## 第四阶段：日志管理

### Task 4.1: 历史日志查询

**功能描述**: 查询 Pod 容器的历史日志

**验收标准**:

- [ ] 能够获取指定容器的历史日志
- [ ] 支持指定日志行数（tail_lines 参数）

- [ ] 支持指定时间范围（since_seconds 参数）
- [ ] 支持显示时间戳

- [ ] 支持查看前一个容器的日志（previous 参数）
- [ ] 支持关键词搜索和高亮

- [ ] 多容器 Pod 必须指定容器名称
- [ ] 容器不存在时返回 404 错误

- [ ] 日志过大时自动截断（最大 10MB）

**测试要点**:

- 测试查询基本日志
- 测试指定行数限制
- 测试时间范围过滤
- 测试时间戳显示
- 测试查看崩溃容器日志（previous）
- 测试关键词搜索
- 测试多容器场景
- 测试日志截断
- 测试容器不存在处理

---

### Task 4.2: 实时日志流（WebSocket）

**功能描述**: 通过 WebSocket 实时推送 Pod 日志

**验收标准**:

- [ ] 能够建立 WebSocket 连接
- [ ] 能够实时推送新产生的日志

- [ ] 支持暂停日志流（客户端控制）
- [ ] 支持恢复日志流（客户端控制）

- [ ] 支持关闭连接（客户端控制）
- [ ] 连接断开时自动清理资源

- [ ] 支持多个客户端同时订阅同一 Pod 日志
- [ ] 认证失败时拒绝连接

- [ ] 容器停止时自动关闭连接

**测试要点**:

- 测试建立 WebSocket 连接
- 测试实时日志推送
- 测试暂停和恢复控制
- 测试主动关闭连接
- 测试被动断开连接（网络故障）
- 测试多客户端场景
- 测试认证验证
- 测试容器停止时的连接关闭
- 测试资源清理

---

### Task 4.3: 日志下载功能

**功能描述**: 支持下载 Pod 日志为文件

**验收标准**:

- [ ] 能够下载完整日志为文本文件
- [ ] 文件名包含 Pod 名称、容器名称和时间戳

- [ ] 支持指定日志行数限制
- [ ] 支持指定时间范围

- [ ] 文件编码为 UTF-8
- [ ] 下载时显示进度（大日志文件）

- [ ] 日志超过 100MB 时分片下载

**测试要点**:

- 测试下载小日志文件
- 测试下载大日志文件
- 测试文件名格式
- 测试日志行数限制
- 测试时间范围过滤
- 测试文件编码
- 测试分片下载
- 测试下载中断恢复

---

### Task 4.4: 日志搜索和高亮

**功能描述**: 在日志中搜索关键词并高亮显示

**验收标准**:

- [ ] 能够按关键词搜索日志内容
- [ ] 支持大小写敏感/不敏感搜索

- [ ] 支持正则表达式搜索
- [ ] 返回匹配行的上下文（前后各 3 行）

- [ ] 高亮显示匹配的关键词
- [ ] 返回匹配行的行号

- [ ] 返回总匹配数量
- [ ] 搜索超时时返回部分结果

**测试要点**:

- 测试简单关键词搜索
- 测试大小写敏感搜索
- 测试正则表达式搜索
- 测试上下文返回
- 测试高亮标记
- 测试行号准确性
- 测试匹配统计
- 测试搜索超时处理
- 测试特殊字符转义

---

### Task 4.5: 多容器日志聚合

**功能描述**: 同时查看 Pod 中所有容器的日志

**验收标准**:

- [ ] 能够获取 Pod 所有容器的日志
- [ ] 日志按时间戳合并排序

- [ ] 每条日志标记容器来源
- [ ] 支持按容器筛选

- [ ] 支持颜色区分不同容器
- [ ] 实时模式下同时订阅所有容器

- [ ] InitContainer 日志单独展示

**测试要点**:

- 测试多容器日志聚合
- 测试时间戳排序
- 测试容器来源标记
- 测试按容器筛选
- 测试颜色标识
- 测试实时订阅多容器
- 测试 InitContainer 日志
- 测试容器启动顺序的日志呈现

---

### Task 4.6: 日志级别过滤

**功能描述**: 按日志级别过滤日志内容

**验收标准**:

- [ ] 能够识别常见日志级别（INFO/WARN/ERROR/DEBUG）
- [ ] 能够按级别筛选日志

- [ ] 支持多级别筛选（如只显示 ERROR 和 WARN）
- [ ] 支持自定义级别关键词

- [ ] 不同级别使用不同颜色显示
- [ ] 统计各级别日志数量

**测试要点**:

- 测试识别标准日志级别
- 测试单级别筛选
- 测试多级别筛选
- 测试自定义级别关键词
- 测试颜色标识
- 测试级别统计
- 测试无法识别级别的日志处理
- 测试不同日志格式兼容性

---

### Task 4.7: 日志导出和分享

**功能描述**: 支持将日志导出并生成分享链接

**验收标准**:

- [ ] 能够导出日志为文本文件
- [ ] 能够导出日志为 JSON 格式

- [ ] 能够生成日志分享链接（临时访问）
- [ ] 分享链接有过期时间（默认 24 小时）

- [ ] 分享链接需要 token 验证
- [ ] 能够撤销分享链接

- [ ] 能够查看分享记录

**测试要点**:

- 测试导出文本格式
- 测试导出 JSON 格式
- 测试生成分享链接
- 测试分享链接访问
- 测试链接过期
- 测试 token 验证
- 测试撤销链接
- 测试分享记录查询

---

## 第五阶段：工作负载和监控

### Task 5.1: Deployment 列表查询

**功能描述**: 查询指定命名空间的所有 Deployment

**验收标准**:

- [ ] 能够获取指定命名空间的所有 Deployment
- [ ] 返回 Deployment 基本信息（名称、副本数、镜像）

- [ ] 返回副本状态（期望副本数、当前副本数、可用副本数）
- [ ] 返回更新策略和更新状态

- [ ] 能够按名称搜索
- [ ] 能够按状态筛选（健康/异常/更新中）

- [ ] 能够分页查询
- [ ] 命名空间不存在时返回 404 错误

**测试要点**:

- 测试查询所有 Deployment
- 测试副本状态准确性
- 测试按名称搜索
- 测试按状态筛选
- 测试分页功能
- 测试更新状态识别
- 测试多容器 Deployment
- 测试命名空间不存在处理

---

### Task 5.2: Deployment 详情查询

**功能描述**: 获取单个 Deployment 的详细信息

**验收标准**:

- [ ] 能够根据名称查询 Deployment 详情
- [ ] 返回完整的 Pod 模板配置

- [ ] 返回更新历史（Revision）
- [ ] 返回关联的 ReplicaSet 列表

- [ ] 返回关联的 Pod 列表
- [ ] 返回资源配置（requests/limits）

- [ ] 返回环境变量和卷配置
- [ ] Deployment 不存在时返回 404 错误

**测试要点**:

- 测试查询存在的 Deployment
- 测试 Deployment 不存在处理
- 测试更新历史解析
- 测试 ReplicaSet 关联
- 测试 Pod 列表关联
- 测试配置信息完整性
- 测试滚动更新中的 Deployment

---

### Task 5.3: Service 列表查询

**功能描述**: 查询指定命名空间的所有 Service

**验收标准**:

- [ ] 能够获取指定命名空间的所有 Service
- [ ] 返回 Service 基本信息（名称、类型、Cluster IP）

- [ ] 返回端口映射信息
- [ ] 返回选择器（Selector）

- [ ] 返回关联的 Endpoint 数量
- [ ] 能够按类型筛选（ClusterIP/NodePort/LoadBalancer）

- [ ] 能够按名称搜索
- [ ] 命名空间不存在时返回 404 错误

**测试要点**:

- 测试查询所有 Service
- 测试按类型筛选
- 测试按名称搜索
- 测试端口映射解析
- 测试 Endpoint 关联
- 测试 Headless Service
- 测试 ExternalName Service
- 测试命名空间不存在处理

---

### Task 5.4: Service 详情查询

**功能描述**: 获取单个 Service 的详细信息

**验收标准**:

- [ ] 能够根据名称查询 Service 详情
- [ ] 返回完整的端口配置

- [ ] 返回关联的 Endpoint 列表（包含 Pod IP）
- [ ] 返回会话亲和性配置

- [ ] 返回 External IP 信息（如有）
- [ ] 返回 LoadBalancer Ingress 信息（如有）

- [ ] 返回关联的 Pod 列表
- [ ] Service 不存在时返回 404 错误

**测试要点**:

- 测试查询存在的 Service
- 测试 Service 不存在处理
- 测试 Endpoint 列表准确性
- 测试多端口 Service
- 测试 LoadBalancer Service
- 测试 NodePort Service
- 测试会话亲和性配置
- 测试关联 Pod 查询

---

### Task 5.5: 集群监控指标采集

**功能描述**: 从 Kubernetes Metrics Server 采集集群监控指标

**验收标准**:

- [ ] 能够查询集群级别的 CPU 使用率
- [ ] 能够查询集群级别的内存使用率

- [ ] 能够统计 Pod 总数和各状态 Pod 数量
- [ ] 能够统计节点总数和各状态节点数量

- [ ] Metrics Server 不可用时返回友好错误
- [ ] 能够按时间范围聚合（1h/24h/7d）

- [ ] 响应时间 < 2 秒

**测试要点**:

- 测试采集集群 CPU 指标
- 测试采集集群内存指标
- 测试 Pod 统计准确性
- 测试节点统计准确性
- 测试 Metrics Server 不可用处理
- 测试时间范围聚合
- 测试查询性能
- 测试指标计算准确性

---

### Task 5.6: 节点监控指标采集

**功能描述**: 采集单个节点的监控指标

**验收标准**:

- [ ] 能够查询节点 CPU 使用率
- [ ] 能够查询节点内存使用率

- [ ] 能够查询节点磁盘使用率
- [ ] 能够查询节点网络流量

- [ ] 能够查询节点上 Pod 数量
- [ ] 能够按时间范围查询历史数据

- [ ] 节点不存在时返回 404 错误

**测试要点**:

- 测试采集节点 CPU 指标
- 测试采集节点内存指标
- 测试采集节点磁盘指标
- 测试采集节点网络指标
- 测试 Pod 数量统计
- 测试历史数据查询
- 测试节点不存在处理
- 测试指标单位转换

---

### Task 5.7: Pod 监控指标采集

**功能描述**: 采集单个 Pod 的监控指标

**验收标准**:

- [ ] 能够查询 Pod CPU 使用率
- [ ] 能够查询 Pod 内存使用率

- [ ] 能够查询 Pod 网络流量
- [ ] 能够查询 Pod 重启次数

- [ ] 多容器 Pod 返回每个容器的指标
- [ ] 能够查询历史数据（最近 1 小时）

- [ ] Pod 不存在时返回 404 错误

**测试要点**:

- 测试采集 Pod CPU 指标
- 测试采集 Pod 内存指标
- 测试采集 Pod 网络指标
- 测试重启次数统计
- 测试多容器指标聚合
- 测试历史数据查询
- 测试 Pod 不存在处理
- 测试容器资源限制对比

---

### Task 5.8: 监控数据缓存

**功能描述**: 缓存监控指标数据，减少对 Metrics Server 的查询压力

**验收标准**:

- [ ] 能够缓存集群监控指标（TTL 30 秒）
- [ ] 能够缓存节点监控指标（TTL 30 秒）

- [ ] 能够缓存 Pod 监控指标（TTL 10 秒）
- [ ] 缓存键包含集群 ID 和资源标识

- [ ] 支持手动刷新缓存
- [ ] 缓存失效时自动重新查询

- [ ] 支持缓存预热（后台定期刷新）

**测试要点**:

- 测试缓存命中率
- 测试 TTL 过期机制
- 测试缓存键生成
- 测试手动刷新
- 测试缓存失效重查询
- 测试缓存预热
- 测试并发访问缓存
- 测试缓存内存占用

---

### Task 5.9: 监控图表数据生成

**功能描述**: 生成前端图表所需的时间序列数据

**验收标准**:

- [ ] 能够生成 CPU 使用率时间序列（最近 1h/24h/7d）
- [ ] 能够生成内存使用率时间序列

- [ ] 能够生成 Pod 状态分布数据（饼图）
- [ ] 能够生成节点资源对比数据（柱状图）

- [ ] 数据点间隔合理（1h: 1分钟, 24h: 5分钟, 7d: 30分钟）
- [ ] 数据格式符合前端图表库要求

- [ ] 缺失数据点使用插值填充

**测试要点**:

- 测试 1 小时时间序列生成
- 测试 24 小时时间序列生成
- 测试 7 天时间序列生成
- 测试数据点间隔
- 测试数据格式
- 测试缺失数据插值
- 测试数据聚合算法
- 测试极值处理

---

### Task 5.10: Ingress 资源查询

**功能描述**: 查询集群中的 Ingress 资源

**验收标准**:

- [ ] 能够获取 Ingress 列表
- [ ] 能够获取 Ingress 详情（包含路由规则）

- [ ] 能够查看关联的 Service
- [ ] 能够查看 TLS 证书配置

- [ ] 能够查看 Ingress Class
- [ ] 能够查看负载均衡器地址

- [ ] 能够按域名搜索

**测试要点**:

- 测试 Ingress 列表查询
- 测试 Ingress 详情查询
- 测试路由规则解析
- 测试 Service 关联
- 测试 TLS 配置查询
- 测试 Ingress Class 识别
- 测试负载均衡器地址
- 测试域名搜索

---

### Task 5.11: PersistentVolume 和 PVC 查询

**功能描述**: 查询持久化存储资源

**验收标准**:

- [ ] 能够获取 PersistentVolume 列表
- [ ] 能够获取 PV 详情（包含容量、访问模式）

- [ ] 能够获取 PersistentVolumeClaim 列表
- [ ] 能够获取 PVC 详情（包含绑定状态）

- [ ] 能够查看 PV 和 PVC 的绑定关系
- [ ] 能够查看使用 PVC 的 Pod

- [ ] 能够查看存储类（StorageClass）

**测试要点**:

- 测试 PV 列表查询
- 测试 PV 详情查询
- 测试 PVC 列表查询
- 测试 PVC 详情查询
- 测试绑定关系查询
- 测试 Pod 使用情况
- 测试 StorageClass 查询
- 测试状态识别（Bound/Pending/Available）

---

## 第六阶段：认证和授权

### Task 6.1: Keycloak 客户端集成

**功能描述**: 集成 Keycloak 认证服务，验证 JWT Token

**验收标准**:

- [ ] 能够配置 Keycloak 连接信息（Realm、Client ID、Client Secret）
- [ ] 能够验证 Keycloak 签发的 JWT Token

- [ ] 能够提取 Token 中的用户信息（user_id、username、email）
- [ ] 能够验证 Token 有效期

- [ ] 能够验证 Token 签名
- [ ] Token 无效时返回 401 错误

- [ ] Token 过期时返回明确的过期错误

**测试要点**:

- 测试配置加载
- 测试有效 Token 验证成功
- 测试无效 Token 被拒绝
- 测试过期 Token 被拒绝
- 测试签名验证
- 测试用户信息提取
- 测试 Keycloak 不可用时的处理
- 测试 Token 黑名单机制

---

### Task 6.2: 用户信息同步

**功能描述**: 从 Keycloak 同步用户信息到本地数据库

**验收标准**:

- [ ] 用户首次登录时自动创建本地用户记录
- [ ] 使用 Keycloak user_id 作为唯一标识

- [ ] 同步用户基本信息（username、email）
- [ ] 首个注册用户自动设置为 super_admin

- [ ] 用户信息变更时能够更新本地记录
- [ ] 用户在 Keycloak 被禁用时无法登录

- [ ] 用户在 Keycloak 被删除时标记为禁用

**测试要点**:

- 测试首次登录创建用户
- 测试重复登录不重复创建
- 测试首个用户设为 super_admin
- 测试用户信息同步更新
- 测试禁用用户拒绝登录
- 测试删除用户处理
- 测试用户唯一标识
- 测试并发登录的用户创建

---

### Task 6.3: OpenFGA 客户端集成

**功能描述**: 集成 OpenFGA 服务，提供细粒度权限管理

**验收标准**:

- [ ] 能够配置 OpenFGA 连接信息（API URL、Store ID、Model ID）
- [ ] 能够初始化授权模型（写入模型定义）

- [ ] 能够建立与 OpenFGA 的连接
- [ ] 连接失败时返回清晰错误

- [ ] 支持 gRPC 和 HTTP 两种连接方式
- [ ] 能够验证模型版本兼容性

**测试要点**:

- 测试配置加载
- 测试连接建立
- 测试授权模型初始化
- 测试连接失败处理
- 测试 gRPC 连接
- 测试 HTTP 连接
- 测试模型版本验证
- 测试连接池管理

---

### Task 6.4: 权限关系写入

**功能描述**: 写入用户和资源的权限关系到 OpenFGA

**验收标准**:

- [ ] 能够创建用户对集群的 owner 关系
- [ ] 能够创建用户对集群的 admin 关系

- [ ] 能够创建用户对集群的 editor 关系
- [ ] 能够创建用户对集群的 viewer 关系

- [ ] 能够删除已存在的权限关系
- [ ] 能够批量写入多个权限关系

- [ ] 写入失败时返回错误并回滚
- [ ] 支持事务性操作（全部成功或全部失败）

**测试要点**:

- 测试创建 owner 关系
- 测试创建 admin 关系
- 测试创建 editor 关系
- 测试创建 viewer 关系
- 测试删除关系
- 测试批量写入
- 测试写入失败回滚
- 测试关系覆盖（升级/降级权限）

---

### Task 6.5: 权限检查功能

**功能描述**: 检查用户是否有权限执行特定操作

**验收标准**:

- [ ] 能够检查用户是否可以查看集群（can_view）
- [ ] 能够检查用户是否可以编辑集群（can_edit）

- [ ] 能够检查用户是否可以删除集群（can_delete）
- [ ] 能够检查用户是否可以管理用户（can_manage_users）

- [ ] super_admin 跳过 OpenFGA 检查（始终返回 true）
- [ ] 无权限时返回 false

- [ ] OpenFGA 不可用时返回错误（fail-secure）

**测试要点**:

- 测试 can_view 权限检查
- 测试 can_edit 权限检查
- 测试 can_delete 权限检查
- 测试 can_manage_users 权限检查
- 测试 super_admin 权限
- 测试无权限场景
- 测试 OpenFGA 不可用处理
- 测试权限继承（organization member → cluster viewer）

---

### Task 6.6: 用户资源列表查询

**功能描述**: 查询用户有权访问的资源列表

**验收标准**:

- [ ] 能够查询用户可查看的所有集群
- [ ] 能够查询用户可编辑的所有集群

- [ ] 能够查询用户可删除的所有集群
- [ ] super_admin 返回所有集群

- [ ] 能够按权限级别筛选
- [ ] 能够分页查询

- [ ] OpenFGA 不可用时返回空列表（fail-secure）

**测试要点**:

- 测试查询可查看集群
- 测试查询可编辑集群
- 测试查询可删除集群
- 测试 super_admin 查询所有集群
- 测试按权限筛选
- 测试分页功能
- 测试 OpenFGA 不可用处理
- 测试查询性能（100+ 集群）

---

### Task 6.7: 权限中间件

**功能描述**: API 请求的权限验证中间件

**验收标准**:

- [ ] 能够拦截所有需要权限的 API 请求
- [ ] 能够从 JWT Token 提取用户 ID

- [ ] 能够从请求路径提取资源 ID
- [ ] 能够根据 HTTP 方法判断所需权限（GET→view, PUT→edit, DELETE→delete）

- [ ] 能够调用 OpenFGA 检查权限
- [ ] 权限不足时返回 403 错误

- [ ] 未认证时返回 401 错误
- [ ] super_admin 跳过权限检查

**测试要点**:

- 测试有权限的请求通过
- 测试无权限的请求被拒绝
- 测试未认证请求被拒绝
- 测试 super_admin 请求通过
- 测试用户 ID 提取
- 测试资源 ID 提取
- 测试权限映射（HTTP 方法 → 权限）
- 测试 OpenFGA 调用失败处理

---

### Task 6.8: 权限缓存机制

**功能描述**: 缓存权限检查结果，提升性能

**验收标准**:

- [ ] 能够缓存权限检查结果（TTL 60 秒）
- [ ] 缓存键包含用户 ID、操作和资源 ID

- [ ] 能够手动刷新缓存
- [ ] 权限变更时自动失效相关缓存

- [ ] 支持批量缓存预热
- [ ] 缓存未命中时查询 OpenFGA

- [ ] 缓存命中率 > 80%

**测试要点**:

- 测试缓存命中
- 测试缓存未命中
- 测试 TTL 过期
- 测试手动刷新
- 测试权限变更失效缓存
- 测试批量预热
- 测试缓存键生成
- 测试并发访问缓存

---

### Task 6.9: 集群添加时的权限初始化

**功能描述**: 用户添加集群时自动设置为该集群的 owner

**验收标准**:

- [ ] 集群创建成功后自动写入 owner 关系
- [ ] 关系格式：`(user:{user_id}, owner, cluster:{cluster_id})`

- [ ] 权限写入失败时回滚集群创建
- [ ] 记录权限初始化操作日志

- [ ] super_admin 创建的集群仍记录 owner 关系
- [ ] 支持指定其他用户为 owner（管理员功能）

**测试要点**:

- 测试集群创建后权限自动设置
- 测试权限写入失败回滚
- 测试操作日志记录
- 测试 super_admin 创建集群
- 测试指定其他用户为 owner
- 测试并发创建集群
- 测试事务完整性

---

### Task 6.10: 用户授权管理接口

**功能描述**: 管理员授予或撤销用户对集群的权限

**验收标准**:

- [ ] 能够授予用户对集群的权限（owner/admin/editor/viewer）
- [ ] 能够撤销用户对集群的权限

- [ ] 能够查询集群的所有权限关系
- [ ] 能够查询用户的所有权限

- [ ] 只有 owner 和 super_admin 可以管理权限
- [ ] 不能撤销集群最后一个 owner 的权限

- [ ] 操作记录审计日志

**测试要点**:

- 测试授予权限
- 测试撤销权限
- 测试查询集群权限
- 测试查询用户权限
- 测试权限验证（只有 owner 可管理）
- 测试最后 owner 保护
- 测试审计日志记录
- 测试权限升级和降级

---

### Task 6.11: 审计日志记录

**功能描述**: 记录所有重要操作的审计日志

**验收标准**:

- [ ] 能够记录用户登录/登出
- [ ] 能够记录集群添加/删除

- [ ] 能够记录权限授予/撤销
- [ ] 能够记录资源删除操作（Pod、Deployment 等）

- [ ] 审计日志包含：操作时间、用户、操作类型、资源、结果
- [ ] 审计日志持久化存储

- [ ] 能够查询审计日志（按用户、时间、操作类型筛选）
- [ ] 审计日志不可删除或修改

**测试要点**:

- 测试登录/登出记录
- 测试集群操作记录
- 测试权限操作记录
- 测试资源删除记录
- 测试日志字段完整性
- 测试日志持久化
- 测试日志查询
- 测试日志不可变性

---

## 第七阶段：API 服务器和集成

### Task 7.1: HTTP 服务器初始化

**功能描述**: 使用 Gin 框架初始化 HTTP 服务器

**验收标准**:

- [ ] 能够通过 `kubez server start` 启动服务器
- [ ] 能够配置监听端口（默认 8080）

- [ ] 能够配置监听地址（默认 0.0.0.0）
- [ ] 能够配置日志级别

- [ ] 能够优雅关闭服务器（收到信号时）
- [ ] 启动时显示监听地址和端口

- [ ] 启动失败时返回明确错误

**测试要点**:

- 测试服务器启动
- 测试端口配置
- 测试地址配置
- 测试日志级别配置
- 测试优雅关闭（SIGTERM/SIGINT）
- 测试端口被占用处理
- 测试启动失败错误处理

---

### Task 7.2: 路由注册

**功能描述**: 注册所有 RESTful API 路由

**验收标准**:

- [ ] 路由按功能模块分组（/api/v1/clusters、/api/v1/logs 等）
- [ ] 所有路由支持 OPTIONS 方法（CORS）

- [ ] 路由包含 API 版本前缀（/api/v1）
- [ ] 能够输出所有注册的路由列表

- [ ] 未定义的路由返回 404
- [ ] 路由支持路径参数（:id、:name 等）

**测试要点**:

- 测试路由注册完整性
- 测试路由分组
- 测试 API 版本前缀
- 测试路由列表输出
- 测试 404 处理
- 测试路径参数解析
- 测试路由冲突检测

---

### Task 7.3: 中间件配置

**功能描述**: 配置 Gin 中间件（日志、恢复、CORS、认证等）

**验收标准**:

- [ ] 配置日志中间件（记录请求和响应）
- [ ] 配置恢复中间件（panic 恢复）

- [ ] 配置 CORS 中间件（跨域支持）
- [ ] 配置认证中间件（JWT 验证）

- [ ] 配置权限中间件（OpenFGA 检查）
- [ ] 配置限流中间件（防止滥用）

- [ ] 中间件按顺序执行
- [ ] 中间件可配置开关

**测试要点**:

- 测试日志记录
- 测试 panic 恢复
- 测试 CORS 配置
- 测试认证中间件
- 测试权限中间件
- 测试限流中间件
- 测试中间件执行顺序
- 测试中间件配置开关

---

### Task 7.4: 统一响应格式

**功能描述**: 实现统一的 JSON 响应格式

**验收标准**:

- [ ] 成功响应格式：`{code: 0, message: "success", data: {}}`
- [ ] 错误响应格式：`{code: 40001, message: "error", error: "detail"}`

- [ ] 分页响应包含 pagination 字段
- [ ] 能够根据错误类型返回对应的 HTTP 状态码

- [ ] 能够包装自定义错误信息
- [ ] 能够包装第三方错误（K8s、OpenFGA）

**测试要点**:

- 测试成功响应格式
- 测试错误响应格式
- 测试分页响应格式
- 测试 HTTP 状态码映射
- 测试自定义错误包装
- 测试第三方错误包装
- 测试空数据处理

---

### Task 7.5: 错误处理机制

**功能描述**: 统一的错误处理和错误码定义

**验收标准**:

- [ ] 定义错误码常量（10000: 系统错误, 20000: 业务错误, 30000: 参数错误, 40000: 认证授权错误）
- [ ] 能够将 Go error 转换为错误响应

- [ ] 能够记录错误日志（包含堆栈信息）
- [ ] 能够返回用户友好的错误消息

- [ ] 开发模式显示详细错误，生产模式隐藏敏感信息
- [ ] 支持错误链追踪

**测试要点**:

- 测试错误码定义完整性
- 测试错误转换
- 测试错误日志记录
- 测试用户友好错误消息
- 测试开发/生产模式差异
- 测试错误链追踪
- 测试敏感信息过滤

---

### Task 7.6: 请求参数验证

**功能描述**: 验证 API 请求参数的有效性

**验收标准**:

- [ ] 能够验证路径参数（如 ID 格式）
- [ ] 能够验证查询参数（如分页参数）

- [ ] 能够验证请求体 JSON 格式
- [ ] 能够验证必填字段

- [ ] 能够验证字段类型和长度
- [ ] 能够验证枚举值

- [ ] 验证失败时返回清晰的错误信息
- [ ] 使用 validator 标签定义验证规则

**测试要点**:

- 测试路径参数验证
- 测试查询参数验证
- 测试 JSON 格式验证
- 测试必填字段验证
- 测试类型和长度验证
- 测试枚举值验证
- 测试错误消息清晰度
- 测试自定义验证规则

---

### Task 7.7: API 限流功能

**功能描述**: 实现 API 请求限流，防止滥用

**验收标准**:

- [ ] 能够按 IP 地址限流（每分钟 60 次）
- [ ] 能够按用户限流（每分钟 100 次）

- [ ] 能够配置不同接口的限流规则
- [ ] 超过限流阈值时返回 429 错误

- [ ] 响应头包含限流信息（X-RateLimit-Limit、X-RateLimit-Remaining）
- [ ] 支持白名单（跳过限流）

- [ ] 限流计数器使用滑动窗口算法

**测试要点**:

- 测试按 IP 限流
- 测试按用户限流
- 测试不同接口限流规则
- 测试超过阈值返回 429
- 测试响应头限流信息
- 测试白名单功能
- 测试滑动窗口算法
- 测试限流重置

---

### Task 7.8: WebSocket 服务器

**功能描述**: 实现 WebSocket 服务器用于实时日志流

**验收标准**:

- [ ] 能够接受 WebSocket 连接
- [ ] 能够验证连接认证（JWT Token）

- [ ] 能够处理客户端控制消息（pause/resume/close）
- [ ] 能够推送实时日志消息

- [ ] 连接断开时自动清理资源
- [ ] 支持连接超时设置

- [ ] 支持并发连接数限制
- [ ] 记录 WebSocket 连接日志

**测试要点**:

- 测试建立连接
- 测试认证验证
- 测试控制消息处理
- 测试消息推送
- 测试连接断开清理
- 测试连接超时
- 测试并发连接限制
- 测试连接日志记录

---

### Task 7.9: 健康检查接口

**功能描述**: 提供服务健康检查接口

**验收标准**:

- [ ] 提供 `/health` 端点返回服务状态
- [ ] 检查数据库连接状态

- [ ] 检查 Keycloak 连接状态
- [ ] 检查 OpenFGA 连接状态

- [ ] 检查 Karmada 连接状态（可选）
- [ ] 所有依赖健康时返回 200

- [ ] 任意依赖异常时返回 503
- [ ] 响应包含各依赖的详细状态

**测试要点**:

- 测试所有依赖健康场景
- 测试数据库异常场景
- 测试 Keycloak 异常场景
- 测试 OpenFGA 异常场景
- 测试 Karmada 异常场景
- 测试部分依赖异常
- 测试响应格式
- 测试健康检查性能

---

### Task 7.10: API 文档生成

**功能描述**: 使用 Swagger/OpenAPI 生成 API 文档

**验收标准**:

- [ ] 能够通过注释生成 API 文档
- [ ] 文档包含所有接口的描述

- [ ] 文档包含请求参数说明
- [ ] 文档包含响应格式说明

- [ ] 文档包含错误码说明
- [ ] 文档包含认证说明

- [ ] 提供 Swagger UI 界面（/swagger/index.html）
- [ ] 文档与代码保持同步

**测试要点**:

- 测试文档生成
- 测试文档完整性
- 测试 Swagger UI 访问
- 测试文档与代码一致性
- 测试示例代码正确性
- 测试认证测试功能
- 测试文档搜索功能

---

### Task 7.11: CORS 配置

**功能描述**: 配置跨域资源共享策略

**验收标准**:

- [ ] 能够配置允许的源（Origins）
- [ ] 能够配置允许的方法（GET、POST、PUT、DELETE 等）

- [ ] 能够配置允许的头部（Authorization、Content-Type 等）
- [ ] 能够配置是否允许凭证（Credentials）

- [ ] 能够配置预检请求缓存时间
- [ ] 开发环境允许所有源

- [ ] 生产环境只允许配置的源

**测试要点**:

- 测试允许的源验证
- 测试允许的方法
- 测试允许的头部
- 测试凭证传递
- 测试预检请求
- 测试开发环境配置
- 测试生产环境配置
- 测试不允许的源被拒绝

---

### Task 7.12: 请求日志和追踪

**功能描述**: 记录 API 请求日志和追踪信息

**验收标准**:

- [ ] 每个请求生成唯一 Request ID
- [ ] 记录请求方法、路径、参数

- [ ] 记录响应状态码和耗时
- [ ] 记录用户信息（已认证请求）

- [ ] 记录客户端 IP 和 User-Agent
- [ ] 错误请求记录详细堆栈信息

- [ ] 响应头包含 Request ID
- [ ] 支持分布式追踪（OpenTelemetry）

**测试要点**:

- 测试 Request ID 生成
- 测试请求信息记录
- 测试响应信息记录
- 测试用户信息记录
- 测试客户端信息记录
- 测试错误堆栈记录
- 测试响应头 Request ID
- 测试分布式追踪集成

---

## 第八阶段：Karmada 集成

### Task 8.1: Karmada 客户端初始化

**功能描述**: 初始化 Karmada API 客户端

**验收标准**:

- [ ] 能够从配置加载 Karmada kubeconfig
- [ ] 能够创建 Karmada API 客户端

- [ ] 能够验证 Karmada API Server 连接
- [ ] 能够获取 Karmada 版本信息

- [ ] 配置错误时返回明确错误
- [ ] 支持 Karmada 客户端重连

**测试要点**:

- 测试客户端初始化
- 测试 kubeconfig 加载
- 测试连接验证
- 测试版本信息获取
- 测试配置错误处理
- 测试重连机制
- 测试客户端池管理

---

### Task 8.2: 集群注册到 Karmada (Push 模式)

**功能描述**: 将 Kubernetes 集群注册为 Karmada 成员集群

**验收标准**:

- [ ] 能够创建 Karmada Cluster 资源
- [ ] 能够配置集群连接信息（API Server、Token）

- [ ] 能够部署 Karmada Agent 到成员集群
- [ ] 能够验证集群注册成功

- [ ] 注册失败时清理部分创建的资源
- [ ] 能够更新集群标签和注解

- [ ] 能够从 Karmada 注销集群

**测试要点**:

- 测试集群注册成功
- 测试注册参数验证
- 测试 Agent 部署
- 测试注册验证
- 测试失败清理
- 测试更新集群信息
- 测试注销集群
- 测试并发注册

---

### Task 8.3: Karmada 集群状态同步

**功能描述**: 从 Karmada 同步成员集群状态

**验收标准**:

- [ ] 能够获取 Karmada Cluster 资源状态
- [ ] 能够同步集群 Ready 状态

- [ ] 能够同步集群版本信息
- [ ] 能够同步集群容量信息

- [ ] 能够更新本地数据库中的集群状态
- [ ] 定期同步（每 60 秒）

- [ ] 同步失败时记录错误日志

**测试要点**:

- 测试状态同步
- 测试 Ready 状态识别
- 测试版本信息同步
- 测试容量信息同步
- 测试数据库更新
- 测试定期同步
- 测试同步失败处理
- 测试并发同步

---

### Task 8.4: 跨集群资源分发 (基础)

**功能描述**: 通过 Karmada 将资源分发到多个集群

**验收标准**:

- [ ] 能够创建 PropagationPolicy 资源
- [ ] 能够指定资源分发的目标集群

- [ ] 能够配置调度策略（副本分割、集群亲和性）
- [ ] 能够查询资源分发状态

- [ ] 分发失败时返回清晰错误
- [ ] 能够更新分发策略

- [ ] 能够删除分发策略

**测试要点**:

- 测试创建分发策略
- 测试指定目标集群
- 测试调度策略配置
- 测试分发状态查询
- 测试分发失败处理
- 测试更新策略
- 测试删除策略
- 测试策略冲突处理

---

### Task 8.5: Karmada 健康检查

**功能描述**: 检查 Karmada 控制平面健康状态

**验收标准**:

- [ ] 能够检查 Karmada API Server 连通性
- [ ] 能够检查 Karmada Scheduler 状态

- [ ] 能够检查 Karmada Controller Manager 状态
- [ ] 能够检查 Karmada Webhook 状态

- [ ] 能够检查 etcd 健康状态
- [ ] 任意组件异常时返回警告

- [ ] 定期检查（每 30 秒）

**测试要点**:

- 测试 API Server 检查
- 测试 Scheduler 检查
- 测试 Controller Manager 检查
- 测试 Webhook 检查
- 测试 etcd 检查
- 测试异常检测
- 测试定期检查
- 测试健康信息存储

---

### Task 8.6: Karmada 降级策略

**功能描述**: Karmada 不可用时的降级处理

**验收标准**:

- [ ] Karmada 不可用时不影响单集群操作
- [ ] 能够直接连接成员集群 API Server

- [ ] 跨集群功能降级为逐个查询
- [ ] 能够检测 Karmada 恢复并自动切回

- [ ] 降级状态记录日志和告警
- [ ] 能够手动切换降级模式

- [ ] 降级模式下功能限制提示用户

**测试要点**:

- 测试 Karmada 不可用检测
- 测试直接连接成员集群
- 测试跨集群功能降级
- 测试自动恢复切换
- 测试降级日志记录
- 测试手动切换
- 测试功能限制提示
- 测试降级性能影响

---

## 第九阶段：前端集成

### Task 9.1: API 客户端封装（前端）

**功能描述**: 封装前端 API 调用逻辑

**验收标准**:

- [ ] 统一的 API 调用接口（使用 fetch API）
- [ ] 自动添加认证 Token（从 Auth.js session 获取）

- [ ] 统一的错误处理
- [ ] 请求和响应拦截器

- [ ] 支持请求取消
- [ ] 支持请求重试

- [ ] 显示加载状态

**测试要点**:

- 测试 API 调用成功
- 测试自动添加 Token
- 测试错误处理
- 测试请求拦截
- 测试响应拦截
- 测试请求取消
- 测试请求重试
- 测试加载状态

---

### Task 9.2: TanStack Query 集成

**功能描述**: 使用 TanStack Query 管理服务端状态

**验收标准**:

- [ ] 配置 QueryClient（缓存时间、重试策略）
- [ ] 实现集群列表查询 Hook

- [ ] 实现 Pod 列表查询 Hook
- [ ] 实现日志查询 Hook

- [ ] 实现监控指标查询 Hook
- [ ] 支持自动刷新（staleTime）

- [ ] 支持乐观更新
- [ ] 支持离线缓存

**测试要点**:

- 测试 QueryClient 配置
- 测试查询 Hook 功能
- 测试缓存策略
- 测试自动刷新
- 测试乐观更新
- 测试离线缓存
- 测试错误重试
- 测试 Loading 状态

---

### Task 9.3: WebSocket 日志客户端

**功能描述**: 实现前端 WebSocket 客户端接收实时日志

**验收标准**:

- [ ] 能够建立 WebSocket 连接
- [ ] 能够发送认证 Token

- [ ] 能够接收日志消息
- [ ] 能够发送控制消息（暂停/恢复）

- [ ] 能够处理连接断开
- [ ] 能够自动重连（指数退避）

- [ ] 能够显示连接状态
- [ ] 能够清理资源

**测试要点**:

- 测试建立连接
- 测试认证
- 测试接收消息
- 测试发送控制消息
- 测试连接断开
- 测试自动重连
- 测试状态显示
- 测试资源清理

---

### Task 9.4: Auth.js + Keycloak 认证配置

**功能描述**: 配置 Auth.js 使用 Keycloak Provider

**验收标准**:

- [ ] 配置 Keycloak Provider（Client ID、Issuer URL）
- [ ] 配置 session 策略（JWT）

- [ ] 实现 jwt callback（添加 access_token）
- [ ] 实现 session callback（添加 user_id）

- [ ] 配置登录页面路由
- [ ] 配置回调 URL

- [ ] 能够获取 session 信息
- [ ] 能够登出并清理 session

**测试要点**:

- 测试 Keycloak 登录流程
- 测试 JWT token 获取
- 测试 session 创建
- 测试 callback 函数
- 测试登录页面跳转
- 测试回调处理
- 测试 session 读取
- 测试登出流程

---

### Task 9.5: 前端路由保护

**功能描述**: 保护需要认证的前端路由

**验收标准**:

- [ ] 未认证用户访问受保护路由时重定向到登录页
- [ ] 登录成功后重定向回原路由

- [ ] 能够在服务端检查认证状态（SSR）
- [ ] 能够在客户端检查认证状态

- [ ] token 过期时自动跳转登录页
- [ ] 支持公开路由（如登录页本身）

**测试要点**:

- 测试未认证访问重定向
- 测试登录后重定向
- 测试服务端认证检查
- 测试客户端认证检查
- 测试 token 过期处理
- 测试公开路由访问
- 测试认证状态持久化

---

### Task 9.6: 全局错误处理和提示

**功能描述**: 统一的前端错误处理和用户提示

**验收标准**:

- [ ] 能够捕获 API 调用错误
- [ ] 能够显示用户友好的错误提示

- [ ] 能够区分不同错误类型（网络、认证、权限、业务）
- [ ] 401 错误自动跳转登录页

- [ ] 403 错误显示权限不足提示
- [ ] 网络错误显示重试按钮

- [ ] 支持 Toast 和 Modal 两种提示方式
- [ ] 能够记录前端错误日志

**测试要点**:

- 测试 API 错误捕获
- 测试错误类型识别
- 测试 401 自动跳转
- 测试 403 权限提示
- 测试网络错误重试
- 测试 Toast 提示
- 测试 Modal 提示
- 测试错误日志记录

---

### Task 9.7: 主题切换功能

**功能描述**: 支持亮色/暗色主题切换

**验收标准**:

- [ ] 能够切换亮色主题
- [ ] 能够切换暗色主题

- [ ] 能够跟随系统主题
- [ ] 主题偏好持久化存储

- [ ] 切换时平滑过渡动画
- [ ] 所有组件适配两种主题

- [ ] 提供主题切换按钮

**测试要点**:

- 测试亮色主题
- 测试暗色主题
- 测试系统主题跟随
- 测试偏好持久化
- 测试切换动画
- 测试组件适配
- 测试主题切换按钮

---

### Task 9.8: 响应式布局适配

**功能描述**: 适配不同屏幕尺寸的响应式布局

**验收标准**:

- [ ] 支持桌面端（≥1280px）
- [ ] 支持平板端（768px-1279px）

- [ ] 支持移动端（<768px）
- [ ] 移动端侧边栏可收起

- [ ] 移动端表格可横向滚动
- [ ] 移动端表单自适应宽度

- [ ] 触摸友好的交互

**测试要点**:

- 测试桌面端布局
- 测试平板端布局
- 测试移动端布局
- 测试侧边栏收起
- 测试表格滚动
- 测试表单适配
- 测试触摸交互

---

### Task 9.9: 国际化支持（i18n）

**功能描述**: 支持多语言切换（MVP 版本支持中英文）

**验收标准**:

- [ ] 支持简体中文
- [ ] 支持英文

- [ ] 能够动态切换语言
- [ ] 语言偏好持久化存储

- [ ] 所有文本支持国际化
- [ ] 日期和时间格式本地化

- [ ] 数字和货币格式本地化

**测试要点**:

- 测试中文显示
- 测试英文显示
- 测试语言切换
- 测试偏好持久化
- 测试文本国际化覆盖
- 测试日期时间格式
- 测试数字格式

---

### Task 9.10: 前端性能优化

**功能描述**: 优化前端加载和运行性能

**验收标准**:

- [ ] 首屏加载时间 < 2 秒
- [ ] 页面切换响应 < 300ms

- [ ] 图片懒加载
- [ ] 路由懒加载（代码分割）

- [ ] 组件懒加载（按需引入）
- [ ] 防抖和节流优化

- [ ] 虚拟滚动（大列表）
- [ ] 使用 Next.js Image 优化

**测试要点**:

- 测试首屏加载时间
- 测试页面切换性能
- 测试图片懒加载
- 测试路由懒加载
- 测试组件懒加载
- 测试防抖节流
- 测试虚拟滚动
- 测试图片优化

---

## 第十阶段：部署和运维

### Task 10.1: Docker 镜像构建（后端）

**功能描述**: 构建后端服务的 Docker 镜像

**验收标准**:

- [ ] 使用多阶段构建减小镜像体积
- [ ] 编译阶段使用 golang:1.21-alpine

- [ ] 运行阶段使用 alpine:3.18
- [ ] 非 root 用户运行

- [ ] 暴露 8080 端口
- [ ] 支持配置文件挂载

- [ ] 支持环境变量配置
- [ ] 镜像大小 < 50MB

**测试要点**:

- 测试镜像构建成功
- 测试镜像体积
- 测试非 root 用户
- 测试端口暴露
- 测试配置文件挂载
- 测试环境变量
- 测试容器启动
- 测试健康检查

---

### Task 10.2: Docker 镜像构建（前端）

**功能描述**: 构建前端应用的 Docker 镜像

**验收标准**:

- [ ] 使用多阶段构建
- [ ] 构建阶段使用 node:20-alpine

- [ ] 运行阶段使用 node:20-alpine
- [ ] 启用 Next.js standalone 输出

- [ ] 非 root 用户运行
- [ ] 暴露 3000 端口

- [ ] 支持环境变量配置
- [ ] 镜像大小 < 200MB

**测试要点**:

- 测试镜像构建成功
- 测试 standalone 输出
- 测试镜像体积
- 测试非 root 用户
- 测试端口暴露
- 测试环境变量
- 测试容器启动
- 测试静态资源访问

---

### Task 10.3: Docker Compose 配置

**功能描述**: 编写 Docker Compose 配置文件

**验收标准**:

- [ ] 定义所有服务（postgres、backend、frontend）
- [ ] 配置服务依赖关系

- [ ] 配置网络（内部桥接网络）
- [ ] 配置持久化卷（postgres_data、kubeconfig）

- [ ] 配置环境变量
- [ ] 配置端口映射

- [ ] 配置健康检查
- [ ] 支持一键启动（docker-compose up）

**测试要点**:

- 测试服务启动顺序
- 测试服务依赖
- 测试网络通信
- 测试数据持久化
- 测试环境变量传递
- 测试端口访问
- 测试健康检查
- 测试一键启动和停止

---

### Task 10.4: Kubernetes 部署清单

**功能描述**: 编写 Kubernetes 部署 YAML 文件

**验收标准**:

- [ ] Backend Deployment（2 副本）
- [ ] Frontend Deployment（2 副本）

- [ ] PostgreSQL StatefulSet（1 副本）
- [ ] Service 资源（ClusterIP）

- [ ] Ingress 资源（统一入口）
- [ ] ConfigMap（应用配置）

- [ ] Secret（敏感信息）
- [ ] PVC（数据持久化）

**测试要点**:

- 测试 Deployment 部署
- 测试副本数配置
- 测试 Service 访问
- 测试 Ingress 路由
- 测试 ConfigMap 挂载
- 测试 Secret 挂载
- 测试 PVC 绑定
- 测试滚动更新

---

### Task 10.5: 数据库备份和恢复

**功能描述**: 实现数据库备份和恢复功能

**验收标准**:

- [ ] 能够执行 `kubez backup create` 创建备份
- [ ] 备份包含所有表数据

- [ ] 备份文件包含时间戳
- [ ] 能够执行 `kubez backup restore <file>` 恢复备份

- [ ] 恢复前提示确认
- [ ] 备份文件加密存储

- [ ] 支持远程备份（S3/OSS）

**测试要点**:

- 测试创建备份
- 测试备份文件完整性
- 测试恢复备份
- 测试恢复确认
- 测试备份加密
- 测试远程备份上传
- 测试备份列表查询
- 测试备份删除

---

### Task 10.6: 日志收集配置

**功能描述**: 配置日志收集到 Loki

**验收标准**:

- [ ] 应用输出结构化 JSON 日志
- [ ] Fluent Bit 收集容器日志

- [ ] 日志推送到 Loki
- [ ] 日志包含标签（namespace、pod、container）

- [ ] Grafana 配置 Loki 数据源
- [ ] 能够通过 Grafana 查询日志

- [ ] 日志保留 7 天

**测试要点**:

- 测试日志格式
- 测试日志收集
- 测试日志推送
- 测试日志标签
- 测试 Grafana 查询
- 测试日志保留策略
- 测试日志搜索性能

---

### Task 10.7: 监控告警配置

**功能描述**: 配置 Prometheus 监控和告警

**验收标准**:

- [ ] 应用暴露 /metrics 接口
- [ ] Prometheus 抓取应用指标

- [ ] 配置告警规则（错误率、响应时间、内存使用）
- [ ] 告警通过 Alertmanager 发送

- [ ] Grafana 配置 Prometheus 数据源
- [ ] 导入预置 Dashboard

- [ ] 告警发送到指定渠道（邮件/Slack）

**测试要点**:

- 测试 metrics 接口
- 测试指标抓取
- 测试告警规则触发
- 测试告警发送
- 测试 Grafana Dashboard
- 测试告警通道
- 测试告警静默

---

### Task 10.8: CI/CD 流水线

**功能描述**: 配置 GitHub Actions CI/CD 流水线

**验收标准**:

- [ ] 代码提交触发 CI（测试、lint）
- [ ] 测试覆盖率报告上传

- [ ] 代码合并到 main 触发 CD（构建镜像）
- [ ] 镜像推送到容器镜像仓库

- [ ] 自动更新 Kubernetes 部署
- [ ] 部署失败时回滚

- [ ] 通知部署结果

**测试要点**:

- 测试 CI 触发
- 测试运行测试
- 测试 lint 检查
- 测试覆盖率报告
- 测试 CD 触发
- 测试镜像构建
- 测试镜像推送
- 测试自动部署

---

### Task 10.9: 性能测试

**功能描述**: 对 API 接口进行性能测试

**验收标准**:

- [ ] 集群列表接口 QPS > 100（单实例）
- [ ] Pod 列表接口 QPS > 50

- [ ] 日志查询接口 QPS > 20
- [ ] 接口响应时间 P95 < 500ms

- [ ] 支持 10 个并发用户
- [ ] 支持管理 10 个集群

- [ ] 内存使用 < 512MB（单实例）

**测试要点**:

- 测试各接口 QPS
- 测试响应时间分布
- 测试并发用户数
- 测试多集群场景
- 测试内存占用
- 测试 CPU 占用
- 测试数据库连接池
- 测试缓存命中率

---

### Task 10.10: 安全扫描

**功能描述**: 对代码和镜像进行安全扫描

**验收标准**:

- [ ] 代码静态安全扫描（gosec）
- [ ] 依赖漏洞扫描（govulncheck）

- [ ] Docker 镜像扫描（Trivy）
- [ ] 无高危漏洞

- [ ] 无中危漏洞（或已评估可接受）
- [ ] 扫描报告存档

- [ ] 定期自动扫描（每周）

**测试要点**:

- 测试代码静态扫描
- 测试依赖漏洞扫描
- 测试镜像漏洞扫描
- 测试漏洞报告生成
- 测试漏洞修复验证
- 测试定期扫描触发
- 测试扫描结果通知

---

### Task 10.11: 配置管理和环境变量

**功能描述**: 规范配置管理和环境变量使用

**验收标准**:

- [ ] 提供配置文件模板（config.example.yaml）
- [ ] 所有敏感配置使用环境变量

- [ ] 配置分环境管理（dev/test/prod）
- [ ] 配置验证和默认值

- [ ] 配置热更新（部分配置）
- [ ] 提供配置文档说明

- [ ] Kubernetes ConfigMap 和 Secret 管理

**测试要点**:

- 测试配置文件模板
- 测试环境变量读取
- 测试分环境配置
- 测试配置验证
- 测试配置热更新
- 测试配置文档完整性
- 测试 K8s ConfigMap 挂载

---

### Task 10.12: 零停机部署

**功能描述**: 实现滚动更新和零停机部署

**验收标准**:

- [ ] Kubernetes Deployment 使用滚动更新策略
- [ ] 配置健康检查探针（Liveness、Readiness）

- [ ] 配置优雅关闭（Grace Period）
- [ ] 新版本就绪后才终止旧版本

- [ ] 部署失败自动回滚
- [ ] 提供手动回滚命令

- [ ] 部署过程可观测

**测试要点**:

- 测试滚动更新
- 测试健康检查探针
- 测试优雅关闭
- 测试流量切换
- 测试自动回滚
- 测试手动回滚
- 测试部署过程监控
- 测试用户无感知更新

---

### Task 10.13: 数据库迁移管理

**功能描述**: 管理生产环境的数据库迁移

**验收标准**:

- [ ] 提供迁移执行计划预览
- [ ] 迁移前自动备份数据库

- [ ] 迁移失败自动回滚
- [ ] 迁移过程记录日志

- [ ] 支持分阶段迁移（大表）
- [ ] 迁移期间最小化停机时间

- [ ] 提供迁移测试环境

**测试要点**:

- 测试迁移计划预览
- 测试自动备份
- 测试迁移执行
- 测试失败回滚
- 测试日志记录
- 测试大表迁移
- 测试停机时间
- 测试测试环境迁移

---

### Task 10.14: 资源限制和自动扩缩容

**功能描述**: 配置资源限制和 HPA 自动扩缩容

**验收标准**:

- [ ] 配置 Pod 资源 requests 和 limits
- [ ] 配置 HPA（Horizontal Pod Autoscaler）

- [ ] 基于 CPU 使用率扩缩容
- [ ] 基于内存使用率扩缩容

- [ ] 配置最小和最大副本数
- [ ] 配置扩缩容策略（稳定窗口、冷却时间）

- [ ] 监控扩缩容事件

**测试要点**:

- 测试资源限制配置
- 测试 HPA 创建
- 测试 CPU 扩容触发
- 测试内存扩容触发
- 测试副本数限制
- 测试扩缩容策略
- 测试事件监控
- 测试负载测试验证

---

### Task 10.15: 故障恢复和灾难演练

**功能描述**: 制定故障恢复计划和定期演练

**验收标准**:

- [ ] 编写故障恢复文档（Runbook）
- [ ] 定期备份数据库和配置

- [ ] 测试从备份恢复
- [ ] 模拟 Pod 故障（Chaos Engineering）

- [ ] 模拟节点故障
- [ ] 模拟网络分区

- [ ] 记录故障演练结果和改进

**测试要点**:

- 测试恢复文档完整性
- 测试数据库备份恢复
- 测试配置恢复
- 测试 Pod 故障恢复
- 测试节点故障恢复
- 测试网络分区处理
- 测试演练记录
- 测试改进措施落地

---

## 附录：测试策略

### 单元测试

- **覆盖率要求**: ≥ 80%（强制），≥ 90%（目标）
- **测试框架**: Go 标准库 testing + testify
- **Mock 框架**: gomock
- **运行命令**: `go test ./... -v -cover`

### 集成测试

- **测试环境**: 使用 Docker Compose 启动依赖服务
- **测试数据**: 使用 testdata 目录存放测试数据
- **清理策略**: 每个测试后清理数据库
- **运行命令**: `go test ./... -tags=integration`

### E2E 测试

- **测试工具**: 前端使用 Playwright
- **测试场景**: 关键用户流程（登录、添加集群、查看日志）
- **测试环境**: 完整的部署环境
- **运行命令**: `npm run test:e2e`

### 性能测试

- **测试工具**: k6 或 Grafana k6
- **测试场景**: 高并发 API 调用
- **性能指标**: QPS、响应时间、错误率
- **运行命令**: `k6 run performance-test.js`

---

## 总结

本任务清单包含 KubeZ 项目 MVP 版本的所有开发任务，共 10 个阶段 **93 个任务**。所有任务严格遵循 TDD 开发模式，确保代码质量和测试覆盖率。

**任务统计**:

- 第一阶段：基础设施和数据模型 - **7 个任务**（移除了 Session 表，使用 JWT 认证）
- 第二阶段：集群管理核心功能 - **9 个任务**
- 第三阶段：Kubernetes 资源查询 - **10 个任务**
- 第四阶段：日志管理 - **7 个任务**
- 第五阶段：工作负载和监控 - **11 个任务**
- 第六阶段：认证和授权 - **11 个任务**（移除了 Session 管理，使用 Keycloak JWT）
- 第七阶段：API 服务器和集成 - **12 个任务**
- 第八阶段：Karmada 集成 - **6 个任务**
- 第九阶段：前端集成 - **10 个任务**
- 第十阶段：部署和运维 - **15 个任务**

**开发优先级**:

1. 第一阶段：基础设施（必须首先完成）
2. 第二阶段：集群管理（核心功能）
3. 第三阶段：资源查询（核心功能）
4. 第四阶段：日志管理（核心功能）
5. 第六阶段：认证授权（安全基础）
6. 第七阶段：API 服务器（集成）
7. 第五阶段：工作负载和监控（增强功能）
8. 第八阶段：Karmada 集成（多集群增强）
9. 第九阶段：前端集成（用户界面）
10. 第十阶段：部署运维（生产就绪）

**开发建议**:

- 每个任务开发前先编写测试用例（TDD Red 阶段）
- 使用最小代码实现功能使测试通过（TDD Green 阶段）
- 重构代码提升质量（TDD Refactor 阶段）
- 每完成一个任务提交一次代码
- 定期运行完整测试套件确保没有回归
- 保持测试覆盖率 ≥ 80%

---

**文档维护**: 本任务清单应随项目进展实时更新，标记已完成的任务，添加新发现的任务。
